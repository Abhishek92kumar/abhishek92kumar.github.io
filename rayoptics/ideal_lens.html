<!doctype html>
<html>
<head>
<title>Ideal Lens Simulator</title>
<style>
body {
    background: white;
    color: #323232;
    font-weight: 300;
    width:  100%;
    height: 100%;
//height: 100vh;
    margin: 0;
    overflow: hidden; /*  Disable scrollbars */
    display: block;  /* No floating content on sides */
//display: flex;
//align-items: center;
//justify-content: center;
//text-align: center;
//font-family: Helvetica neue, roboto;
}

img {
  width: 56px;
  height: 48px;
}

h1 {
  font-weight: 200;
  font-style: 26px;
  margin: 10px;
}
</style>
<script  src="dat.gui.min.js"></script>
<style src="dat.gui.css"></style>

</head>
	
<body>
<div id="canvasdiv" class="container" align="center">
    <canvas id="canvas" style="border: 1px solid #c3c3c3;" >Your browser does not support the HTML5 canvas tag.</canvas>

</div>
	
<script type='text/javascript'>

    var canvas =document.getElementById('canvas');
    var ctx=canvas.getContext("2d");
    ctx.font="Arial 12 bold";
    ctx.textAlign="center";
    ctx.textBaseline="middle";

    window.addEventListener('resize',function(ev) { return resize(ev); });
    window.addEventListener('resize',function(ev) { return resize(ev); });
    canvas.addEventListener('mousemove',function(ev) { return doMouse(ev); });
    canvas.addEventListener('mousedown',function(ev) { return doMouse(ev); });
    canvas.addEventListener('mouseup',function(ev) { return doMouse(ev); });
    canvas.addEventListener('wheel',function(event){
        zoom(event.wheelDelta);
        event.preventDefault();
    }, false);

    // Set up touch events for mobile, etc
    canvas.addEventListener("touchstart", function (e) {
        let touch = e.touches[0];
        let mouseEvent = new MouseEvent("mousedown", {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }, false);

    canvas.addEventListener("touchend", function (e) {
        let mouseEvent = new MouseEvent("mouseup", {});
        canvas.dispatchEvent(mouseEvent);
    }, false);

    canvas.addEventListener("touchmove", function (e) {
        let touch = e.touches[0];
        let mouseEvent = new MouseEvent("mousemove", {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }, {passive: false});

    // Prevent scrolling when touching the canvas
    document.body.addEventListener("touchstart", function (e) {
        if (e.target == canvas) {
            e.preventDefault();
        }
    });
    document.body.addEventListener("touchend", function (e) {
        if (e.target == canvas) {
            e.preventDefault();
        }
    }, {passive: false});
    document.body.addEventListener("touchmove", function (e) {
        //if (e.target == canvas) {
        e.preventDefault();
        //}
    },{passive: false});

    function resize(){
       canvas.width = window.innerWidth;
       canvas.height = window.innerHeight;
       update();
    }
    function zoom(wheelDelta){
        if(wheelDelta>0){
            scale*=1.025;
        }else {
            scale *= 0.98;
        }
        for (var i in gui.__controllers) {
            gui.__controllers[i].updateDisplay();
        }
        update();
    }

    function doMouse(ev){
        let xy = getEventXY(ev);
        let x = xy.x;
        let y = xy.y;

        if(ev.type === 'mousedown' ){//|| ev.type ==='touchstart') {
            // See if we're clicking a charge.
            prevMouseDown={x:x,y:y};
            x-=(offset.x+canvas.width/2);
            y-=(offset.y+canvas.height/2);
            x/=scale;
            y/=scale;
            if(x>u-3*scale && x<u+6.5*scale&& y>-100 && y<0){
                dragMode=1;
            }else{
                dragMode=0;
            }
            update();
        }
        if(ev.type === 'mousemove' ){//|| ev.type ==='touchmove') {
            if(prevMouseDown!=null) {
                let dx=(x - prevMouseDown.x);
                let dy=(y - prevMouseDown.y);
                if(dragMode==0){
                    offset.x += dx;
                    offset.y += dy;
                }else{
                    u+=dx/scale;
                    if(u<-400)u=-400;
                    if(u>-10)u=-10;
                }

                prevMouseDown={x:x,y:y};
                update();
                for (var i in gui.__controllers) {
                    gui.__controllers[i].updateDisplay();
                }
            }
        }
        if(ev.type === 'mouseup' ){//|| ev.type ==='touchend') {
            prevMouseDown=null;
            update();
        }


    }



    function getAbsolutePosition(element) {
        var r = { x: element.offsetLeft, y: element.offsetTop };
        if (element.offsetParent) {
            var tmp = getAbsolutePosition(element.offsetParent);
            r.x += tmp.x;
            r.y += tmp.y;
        }
        return r;
    }

    function getEventXY(canvas,ev)
    {
        // Convert mouse click coordinates to the mathematical plane.
        var offset = getAbsolutePosition(canvas,ev);

        var x = ev.pageX;
        var y = ev.pageY;

        x = x - offset.x;
        y = y - offset.y;
        return {x:x, y:y};
    }


    function sign(f){
        return f>0?1:(f<0?-1:0);
    }

    var u=-90,v=180,f=60,m=-2;

    var displayEye=true;
    var displayRays=true;
    var displayResult=true;
    var scale=1;
    var offset={x:0,y:0};
    var prevMouseDown=null;
    var dragMode=0; //0 ==drag world, 1=drag object
    //create gui
    var gui = new dat.GUI({name:"Field Controllers"});

    // String field
    //gui.add(window, "u").name("Object Position  ").min(-400).max(-5).step(1).onChange(update);
    gui.add(window, "f").name("Focal length").min(-225).max(225).step(1).onChange(update);
    gui.add(window, "displayEye").name("Draw Eye").onChange(update);
    gui.add(window, "displayRays").name("Draw Rays").onChange(update);
    gui.add(window, "displayResult").name("Display Result").onChange(update);
    gui.add(window, "scale").name("Scale  ").min(0.1).max(5).step(0.01).onChange(update);

    var bg_color="rgb(0,64,84)";
    var lensHeight=100;
    var objHeight=lensHeight*0.6;
    var dragMode=0;
    //0 means none, 1 means object and 2 means lens
    var imageEye=new Image();
    imageEye.src="eye.png";
    var imageRO=new Image();
    imageRO.src="img_Object.png";
    var imageVO=new Image();
    imageVO.src="img_Virtual.png";

    imageVO.onload=update;
    resize();
    update();
    function update(){
        //Console.println("f="+f);
        if(f==0){
            f=Infinity;
            v=u;
            m=1;
            //Console.println("f=infinit"+f);
        }else if(u==-f){
            v=f;
            m=Infinity;
        }else{
            v=u*f/(u+f);
            m=v/u;
        }
        draw();
    }

    //render with center at world
    function draw(){
        this.ctx.font = '12pt sans-serif';

        ctx.fillStyle=bg_color;
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.resetTransform();
        //scale=World.getCamera().getScale()/100;
        //let tx=World.getCamera().getOffset();
        ctx.translate(canvas.width/2+offset.x,canvas.height/2+offset.y);
        ctx.scale(scale,scale);
        //ctx.translate(canvas.width/2+offset.x,canvas.height/2+offset.y);
        drawAxis();
        drawLens();
        drawObject();
        if(m!=Infinity)drawImage();
        if(displayRays){
            drawRays();
        }
        ctx.resetTransform();
        if(displayResult)drawSolution();
    }

    function drawSolution(){
        ctx.textAlign="left";
        this.ctx.font = '14pt sans-serif';

        let x=20,y=canvas.height-100;

        ctx.fillText("u = "+u.toFixed(0)+" cm ," +" f = "+f.toFixed(0)+" cm", x, y);
        y+=30;
        ctx.fillText("using -1/u+1/v = 1/f  \u{27F9} "+"v = "+v.toFixed(1)+" cm", x, y);

        y+=30;
        ctx.fillStyle="yellow";
        ctx.fillText("Nature of image is "+(v>0?"Real,":"Virtual,")+(m>0?" Erect &":" Inverted &") +(Math.abs(m)==1?" Same Size":(Math.abs(m)>1?" Magnified":" Diminished"))+" (m = "+m.toFixed(2)+")", x, y);

        y+=30;

        ctx.font="Arial 12 bold";
        ctx.fillStyle="green";
        ctx.fillText("Drag the object by mouse to change its location, Use mouse wheel to zoom", x, y);
        ctx.textAlign="center";
    }


    function drawRay(x1,y1,x2,y2,t){
        if(!t)t=0.5;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        let x=x1*(1-t)+x2*t;
        let y=y1*(1-t)+y2*t;
        ctx.moveTo(x,y);
        let d=Math.hypot(x2-x1,y2-y1);
        let qx=8*(x2-x1)/d;
        let qy=8*(y2-y1)/d;

        let px=-0.5*qy;
        let py= 0.5*qx;
        //  p.setMagnitude(5).rotate(3*Math.PI/4);
        ctx.moveTo(x+qx,y+qy);
        ctx.lineTo(x+px,y+py);
        ctx.moveTo(x+qx,y+qy);
        ctx.lineTo(x-px,y-py);
        ctx.stroke();

    }

    function drawRays(){
        ctx.strokeStyle="yellow";
        ctx.lineWidth=1.5;

        if(m==Infinity){
            ctx.beginPath();
            drawRay(0, -objHeight,4*f, objHeight*3);
            drawRay(0, 0,4*f, -objHeight*4*f/u);
        }else if (f==Infinity){
            drawRay(u, -objHeight,-2*u, -objHeight);
            drawRay(u, -objHeight,-2*u, objHeight*2);
            if(displayEye)ctx.drawImage(imageEye,0,0,imageEye.width,imageEye.height,240,-80,-160,160);
        }else{
            let vy=-objHeight*m;
            if(v>0){
                ctx.beginPath();
                drawRay(0, -objHeight,v, vy,0.2);
                drawRay(0, 0,v, vy,0.2);
                let x=v+80;
                let y1=vy+80*(vy)/v;
                let y2=vy+80*(vy+objHeight)/v;
                if(displayEye){
                    ctx.save();
                    let s=160;//Math.abs(m*160);
                    ctx.translate(x, (y1+y2)*0.5);
                    ctx.rotate(3.14+Math.atan((y1+y2)*0.5/v));
                    ctx.drawImage(imageEye,0,0,imageEye.width,imageEye.height,-s/2,-s/2,s,s);
                    ctx.restore();
                }
                y=vy+80*(vy)/v;
                drawRay(0, 0,x, y,1);
                y=vy+80*(vy+objHeight)/v;
                drawRay(0, -objHeight,x, y,1);

            }else{
                let i=sign(f);
                ctx.beginPath();
                ctx.lineWidth=2;
                //if(Math.abs(u+f)>10)ctx.lineDash=[3,3];
                //else ctx.lineWidth=0.2;
                ctx.save();
                ctx.strokeStyle="orange";
                ctx.setLineDash([5, 3]);
                ctx.moveTo(0, -objHeight);
                ctx.lineTo(v, vy);
                ctx.moveTo(0, 0);
                ctx.lineTo(v, vy);
                ctx.stroke();
                ctx.restore();

                ctx.beginPath();
                ctx.lineWidth=1.5;
                ctx.strokeStyle="yellow";
                let x=3*f*i;
                let y1=i*2*objHeight;
                let y2=-i*objHeight*2*f/u;
                if(displayEye){
                    ctx.save();
                    let s=160;//Math.abs(m*160);
                    y2=(y1+y2)*0.5;
                    ctx.translate(x, y2);
                    ctx.rotate(3.14+Math.atan((y2+objHeight*m)/(x-v)));
                    ctx.drawImage(imageEye,0,0,imageEye.width,imageEye.height,-s/2,-s/2,s,s);
                    ctx.restore();
                }
                drawRay(0, -objHeight,i*10*f, i*9*objHeight,0.2);
                drawRay(0, 0,i*10*f, -i*objHeight*10*f/u,0.2);

            }
        }
        ctx.strokeStyle="yellow";
        drawRay(u, -objHeight,0, -objHeight);
        drawRay(u, -objHeight,0, 0);
        ctx.strokeStyle="white";
    }


    function drawAxis(){
        ctx.strokeStyle="white";
        ctx.fillStyle=ctx.strokeStyle;
        ctx.beginPath();
        ctx.moveTo(-canvas.width/2, 0);
        ctx.lineTo(canvas.width/2, 0);
        ctx.stroke();
        ctx.fillText("F\u{2081}", f,15);
        ctx.fillText("F\u{2082}", -f,15);
    }

    function drawObject(){
        let img=u<0?imageRO:imageVO;
        ctx.drawImage(img, 0,0,img.width,img.height,u-objHeight/10,-objHeight,objHeight/5,objHeight);
        ctx.fillText("O", u,15);
    }

    function drawImage(){
        let img=u<0?imageRO:imageVO;
        if(f<0)ctx.drawImage(img, 0,0,img.width,img.height,v-m*objHeight/10,-m*objHeight,m*objHeight/5,m*objHeight);
        img=v>0?imageRO:imageVO;
        ctx.drawImage(img, 0,0,img.width,img.height,v-m*objHeight/10,-m*objHeight,m*objHeight/5,m*objHeight);
        ctx.fillText("I", v,m>0?15:-5);
    }


    function drawLens(){
        //ctx.save();
        //ctx.translate(x,y);
        ctx.lineWidth = 2;
        ctx.fillStyle="rgba(135,206,235,0.6)";
        ctx.strokeStyle="skyblue";
        ctx.beginPath();
        if(f==Infinity){
            ctx.beginPath();
            ctx.rect(-5, -lensHeight, 10, 2*lensHeight);
        }else if (f>0){
            let th = 2*Math.atan((10-(f-1)/lensHeight)/lensHeight);
            let R = lensHeight/Math.sin(th);
            ctx.arc(R-(10-(f-1)/lensHeight), 0, R, Math.PI-th, Math.PI+th);
            ctx.arc(-R+(10-(f-1)/lensHeight), 0, R, -th, th);
        }else {
            let th = 2*Math.atan((10-(1-f)/lensHeight)/lensHeight);
            var R = lensHeight/Math.sin(th);
            ctx.beginPath();
            ctx.arc(R+1, 0, R, Math.PI-th, Math.PI+th);
            ctx.lineTo(-(10-(1-f)/lensHeight), -lensHeight);
            ctx.arc(-R-1, 0, R, -th, th);
            ctx.lineTo((10-(1-f)/lensHeight), lensHeight);
        }
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(-f, 0, 2.5, 0,Math.PI*2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(f, 0, 2.5, 0,Math.PI*2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(0, 0, 2.5, 0,Math.PI*2);
        ctx.fill();
    }



</script>
</body>
</html>
